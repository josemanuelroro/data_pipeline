services:
  # --- CI/CD ---
  jenkins:
    build: ./jenkins
    container_name: cicd_jenkins
    #user: root
    environment:
      - JENKINS_OPTS="--logfile=/var/jenkins_home/jenkins.log"
    #ports:
    #  - "8081:8080"
    #  - "50000:50000"
    expose:
    - "8080"
    volumes:
      #- jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ../backend/data_shared:/data_shared
      - ./jenkins/scripts/01-security-audit.groovy:/var/jenkins_home/init.groovy.d/01-security-audit.groovy
      - ../backend/.env:/var/jenkins_home/secrets/.env:ro
      - ./jenkins/config:/var/jenkins_home
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      jenkins-permissions:
        condition: service_completed_successfully
    networks:
      - link_network
    #command: chmod 666 /var/run

#Jenkins permissions
  jenkins-permissions:
      image: alpine:latest
      container_name: jenkins_fix
      volumes:
        - ./jenkins/config:/var/jenkins_home
        - /var/run/docker.sock:/var/run/docker.sock
        - ../backend/data_shared:/data_shared
      command: sh -c "chown -R 1000:1000 /var/jenkins_home /data_shared && chmod 666 /var/run/docker.sock"

  # --- WATCHER ---
  nginx:
    build: ./nginx
    container_name: gateway_nginx
    user: root
    ports:
      - "90:80" 
    volumes:
      #- ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./data_shared/logs:/var/log/nginx
      - ./nginx/templates:/etc/nginx/templates
      #- ./nginx/auth:/etc/nginx/auth
    depends_on:
      - jenkins
      - airflow
      - minio
    environment:
      - NGINX_USER=${NGINX_USER}
      - NGINX_PASSWORD=${NGINX_PASSWORD}
      - JENKINS_DOMAIN=${JENKINS_DOMAIN}
      - AIRFLOW_DOMAIN=${AIRFLOW_DOMAIN}
      - MINIO_USER=${MINIO_USER}
      - MINIO_PASSWORD=${MINIO_PASSWORD}
      - MINIO_DOMAIN=${MINIO_DOMAIN}
    networks:
      #- backend_data_network
      - link_network


  # --- Orchestration (Airflow) ---
  airflow:
    container_name: airflow
    build: 
      context: .
      dockerfile: airflow/Dockerfile
    restart: always
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - _AIRFLOW_WWW_USER_CREATE=true
      - _AIRFLOW_WWW_USER_USERNAME=airflow
      - _AIRFLOW_WWW_USER_PASSWORD=airflow
      - AIRFLOW__CORE__PARALLELISM=4 
      - AIRFLOW__CORE__DAG_CONCURRENCY=4 
      - AIRFLOW__SCHEDULER__MIN_FILE_PROCESS_INTERVAL=30 
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - CHAT_ID=${CHAT_ID}
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      jenkins-permissions:
        condition: service_completed_successfully
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    #ports:
    #  - "8080:8080"
    expose:
    - "8080"
    networks:
      - link_network
    command: >
      bash -c "airflow db migrate && airflow users create --username ${AIRFLOW_USER} --password ${AIRFLOW_PASSWORD} --firstname Admin --lastname User --role Admin --email admin@example.com || true  && (airflow scheduler &) && airflow webserver"

# --- DATA LAKE ---
  minio:
    image: minio/minio
    container_name: minio_container
    restart: always
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    #ports:
    #  - "9000:9000" #spark
    #  - "9001:9001" #web GUI (behind NGINX)
    #- "127.0.0.1:9000:9000"
    expose: 
      - "9001"
      #- "9000"
    volumes:
      - ./datalake_minio:/data
    networks:
      - link_network
    command: server /data --console-address ":9001"


# --- DB (MySQL) ---
  mysql_db:
    build: ./mysql_init
    container_name: mysql_db
    networks:
      - link_network
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      #MYSQL_USER: ${MYSQL_USER}
    expose:
      - "3306"
    volumes:
      #- mysql_data:/var/lib/mysql
      #- ./data_shared:/app/data/shared  
      - ./mysql_init/init.sql:/docker-entrypoint-initdb.d/init.sql
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

 # --- HIVE ---     
  hive-metastore:
      build: ./hive
      container_name: hive-metastore
      depends_on:
        mysql_db:
          condition: service_healthy
        minio:
          condition: service_started
      environment:
        SERVICE_NAME: metastore
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
        MINIO_USER: ${MINIO_USER}
        MINIO_PASSWORD: ${MINIO_PASSWORD}
        HIVE_PASSWORD: ${HIVE_PASSWORD}
      volumes:
        - ./hive/conf/hive-site.xml:/tmp/hive-site_source.xml
      networks:
        - link_network
      entrypoint:
      - "/bin/bash"
      - "-c"
      - |
        cp /tmp/hive-site_source.xml /opt/hive/conf/hive-site.xml
        sed -i "s|test|$HIVE_PASSWORD|g" /opt/hive/conf/hive-site.xml
        grep "ConnectionPassword" -A 1 /opt/hive/conf/hive-site.xml
        /opt/hive/bin/schematool -dbType mysql -initOrUpgradeSchema && \
        /opt/hive/bin/hive --service metastore


 # --- TRINO --- 
  trino:
    build: ./trino  
    container_name: trino
    depends_on:
        mysql_db:
          condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      MINIO_USER: ${MINIO_USER}
      MINIO_PASSWORD: ${MINIO_PASSWORD}
    networks:
      - link_network
  
volumes:
  jenkins_home:

networks:
  link_network:
   driver: bridge
   name: link_network
